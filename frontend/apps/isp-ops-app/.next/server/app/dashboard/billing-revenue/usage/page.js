(()=>{var e={};e.id=7928,e.ids=[7928],e.modules={72934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},27790:e=>{"use strict";e.exports=require("assert")},84770:e=>{"use strict";e.exports=require("crypto")},17702:e=>{"use strict";e.exports=require("events")},92048:e=>{"use strict";e.exports=require("fs")},32615:e=>{"use strict";e.exports=require("http")},32694:e=>{"use strict";e.exports=require("http2")},35240:e=>{"use strict";e.exports=require("https")},19801:e=>{"use strict";e.exports=require("os")},55315:e=>{"use strict";e.exports=require("path")},76162:e=>{"use strict";e.exports=require("stream")},74175:e=>{"use strict";e.exports=require("tty")},17360:e=>{"use strict";e.exports=require("url")},21764:e=>{"use strict";e.exports=require("util")},71568:e=>{"use strict";e.exports=require("zlib")},58295:(e,t,s)=>{"use strict";s.r(t),s.d(t,{GlobalError:()=>n.a,__next_app__:()=>p,originalPathname:()=>u,pages:()=>c,routeModule:()=>h,tree:()=>o}),s(19453),s(13321),s(46366),s(96560);var a=s(23191),r=s(88716),i=s(37922),n=s.n(i),d=s(95231),l={};for(let e in d)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(l[e]=()=>d[e]);s.d(t,l);let o=["",{children:["dashboard",{children:["billing-revenue",{children:["usage",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(s.bind(s,19453)),"/Users/michaelayoade/Downloads/Projects/dotmac-ftth-ops/split-staging/dotmac-isp/frontend/apps/isp-ops-app/app/dashboard/billing-revenue/usage/page.tsx"]}]},{}]},{}]},{layout:[()=>Promise.resolve().then(s.bind(s,13321)),"/Users/michaelayoade/Downloads/Projects/dotmac-ftth-ops/split-staging/dotmac-isp/frontend/apps/isp-ops-app/app/dashboard/layout.tsx"]}]},{layout:[()=>Promise.resolve().then(s.bind(s,46366)),"/Users/michaelayoade/Downloads/Projects/dotmac-ftth-ops/split-staging/dotmac-isp/frontend/apps/isp-ops-app/app/layout.tsx"],"not-found":[()=>Promise.resolve().then(s.bind(s,96560)),"/Users/michaelayoade/Downloads/Projects/dotmac-ftth-ops/split-staging/dotmac-isp/frontend/apps/isp-ops-app/app/not-found.tsx"]}],c=["/Users/michaelayoade/Downloads/Projects/dotmac-ftth-ops/split-staging/dotmac-isp/frontend/apps/isp-ops-app/app/dashboard/billing-revenue/usage/page.tsx"],u="/dashboard/billing-revenue/usage/page",p={require:s,loadChunk:()=>Promise.resolve()},h=new a.AppPageRouteModule({definition:{kind:r.x.APP_PAGE,page:"/dashboard/billing-revenue/usage/page",pathname:"/dashboard/billing-revenue/usage",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:o}})},91796:(e,t,s)=>{Promise.resolve().then(s.bind(s,83272))},83272:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>y});var a=s(10326),r=s(17577),i=s(66697),n=s(21405),d=s(41291),l=s(83855),o=s(48723),c=s(34041),u=s(20892);let p=s(36607).LM.api.baseUrl,h="/api/isp/v1/admin";class g{constructor(){this.baseUrl=p}getAuthHeaders(){return{"Content-Type":"application/json",credentials:"include"}}async handleResponse(e){if(!e.ok)throw Error(await e.text()||`HTTP ${e.status}: ${e.statusText}`);return e.json()}async listUsageRecords(e={}){let t=new URLSearchParams;e.customer_id&&t.append("customer_id",e.customer_id),e.subscription_id&&t.append("subscription_id",e.subscription_id),e.usage_type&&t.append("usage_type",e.usage_type),e.billed_status&&t.append("billed_status",e.billed_status),e.period_start&&t.append("period_start",e.period_start),e.period_end&&t.append("period_end",e.period_end),void 0!==e.limit&&t.append("limit",e.limit.toString()),void 0!==e.offset&&t.append("offset",e.offset.toString());let s=t.toString(),a=`${this.baseUrl}${h}/billing/usage/records${s?`?${s}`:""}`,r=await fetch(a,{method:"GET",headers:this.getAuthHeaders(),credentials:"include"});return(await this.handleResponse(r)).usage_records||[]}async getUsageRecord(e){let t=await fetch(`${this.baseUrl}${h}/billing/usage/records/${e}`,{method:"GET",headers:this.getAuthHeaders(),credentials:"include"});return this.handleResponse(t)}async createUsageRecord(e){let t=await fetch(`${this.baseUrl}${h}/billing/usage/records`,{method:"POST",headers:this.getAuthHeaders(),credentials:"include",body:JSON.stringify(e)});return this.handleResponse(t)}async createUsageRecordsBulk(e){let t=await fetch(`${this.baseUrl}${h}/billing/usage/records/bulk`,{method:"POST",headers:this.getAuthHeaders(),credentials:"include",body:JSON.stringify({records:e})});return(await this.handleResponse(t)).usage_records||[]}async updateUsageRecord(e,t){let s=await fetch(`${this.baseUrl}${h}/billing/usage/records/${e}`,{method:"PATCH",headers:this.getAuthHeaders(),credentials:"include",body:JSON.stringify(t)});return this.handleResponse(s)}async deleteUsageRecord(e){let t=await fetch(`${this.baseUrl}${h}/billing/usage/records/${e}`,{method:"DELETE",headers:this.getAuthHeaders(),credentials:"include"});if(!t.ok&&204!==t.status)throw Error(await t.text()||`HTTP ${t.status}: ${t.statusText}`)}async markUsageRecordsAsBilled(e,t){let s=await fetch(`${this.baseUrl}${h}/billing/usage/records/mark-billed`,{method:"POST",headers:this.getAuthHeaders(),credentials:"include",body:JSON.stringify({usage_ids:e,invoice_id:t})});if(!s.ok)throw Error(await s.text()||`HTTP ${s.status}: ${s.statusText}`)}async excludeUsageRecordsFromBilling(e){let t=await fetch(`${this.baseUrl}${h}/billing/usage/records/exclude`,{method:"POST",headers:this.getAuthHeaders(),credentials:"include",body:JSON.stringify({usage_ids:e})});if(!t.ok)throw Error(await t.text()||`HTTP ${t.status}: ${t.statusText}`)}async listUsageAggregates(e={}){let t=new URLSearchParams;e.customer_id&&t.append("customer_id",e.customer_id),e.subscription_id&&t.append("subscription_id",e.subscription_id),e.usage_type&&t.append("usage_type",e.usage_type),e.period_type&&t.append("period_type",e.period_type),e.period_start&&t.append("period_start",e.period_start),e.period_end&&t.append("period_end",e.period_end),void 0!==e.limit&&t.append("limit",e.limit.toString()),void 0!==e.offset&&t.append("offset",e.offset.toString());let s=t.toString(),a=`${this.baseUrl}${h}/billing/usage/aggregates${s?`?${s}`:""}`,r=await fetch(a,{method:"GET",headers:this.getAuthHeaders(),credentials:"include"});return(await this.handleResponse(r)).aggregates||[]}async getUsageStatistics(e,t){let s=new URLSearchParams;e&&s.append("period_start",e),t&&s.append("period_end",t);let a=s.toString(),r=`${this.baseUrl}${h}/billing/usage/stats${a?`?${a}`:""}`,i=await fetch(r,{method:"GET",headers:this.getAuthHeaders(),credentials:"include"});return this.handleResponse(i)}async getUsageChartData(e){let t=new URLSearchParams;t.append("period_type",e.period_type),void 0!==e.days&&t.append("days",e.days.toString()),e.period_start&&t.append("period_start",e.period_start),e.period_end&&t.append("period_end",e.period_end);let s=t.toString(),a=`${this.baseUrl}${h}/billing/usage/analytics/chart${s?`?${s}`:""}`,r=await fetch(a,{method:"GET",headers:this.getAuthHeaders(),credentials:"include"});return this.handleResponse(r)}calculateTotalAmount(e,t){return Math.round(e*t)}formatCurrency(e,t="USD"){return new Intl.NumberFormat("en-US",{style:"currency",currency:t}).format(e/100)}calculateUsagePercentage(e,t){return 0===t?100:Math.min(e/t*100,100)}}let m=new g,x={data_transfer:"Data Transfer",voice_minutes:"Voice Minutes",sms_count:"SMS",bandwidth_gb:"Bandwidth",overage_gb:"Overage",static_ip:"Static IP",equipment_rental:"Equipment Rental",installation_fee:"Installation",custom:"Custom"},b={data_transfer:"GB",bandwidth_gb:"GB",overage_gb:"GB",voice_minutes:"minutes",sms_count:"messages",static_ip:"ip",equipment_rental:"unit",installation_fee:"job",custom:"unit"},_={subscription_id:"",customer_id:"",usage_type:"data_transfer",quantity:10,unit:"GB",unitPriceMajor:"1.5",description:""};function y(){let[e,t]=(0,r.useState)([]),[s,p]=(0,r.useState)(null),[h,g]=(0,r.useState)(!0),[y,f]=(0,r.useState)(null),[j,v]=(0,r.useState)(_),[w,T]=(0,r.useState)(!1),S=(0,r.useMemo)(()=>m.formatCurrency(Math.round((j.quantity||0)*parseFloat(j.unitPriceMajor||"0")*100)),[j.quantity,j.unitPriceMajor]),P=async()=>{g(!0),f(null);try{let[e,s]=await Promise.all([m.listUsageRecords({limit:50}),m.getUsageStatistics()]);t(e),p(s)}catch(e){f(e?.message||"Failed to load usage billing data")}finally{g(!1)}},U=(e,t)=>{v(s=>({...s,[e]:t})),"usage_type"===e&&v(e=>{let s=b[t]||e.unit;return{...e,unit:s}})},N=async()=>{T(!0),f(null);try{let e=Math.round(100*parseFloat(j.unitPriceMajor||"0")),t={subscription_id:j.subscription_id||"default",usage_type:j.usage_type,quantity:Number(j.quantity),unit:j.unit,unit_price:e,total_amount:m.calculateTotalAmount(j.quantity,e),currency:"USD",period_start:new Date().toISOString(),period_end:new Date().toISOString(),source_system:"ops-portal"};j.customer_id&&(t.customer_id=j.customer_id),j.description&&(t.description=j.description),await m.createUsageRecord(t),await P(),v(_)}catch(e){f(e?.message||"Failed to record usage")}finally{T(!1)}},C=(e,t,s)=>(0,a.jsxs)(o.Card,{children:[(0,a.jsx)(o.CardHeader,{children:(0,a.jsx)(o.CardTitle,{className:"text-sm text-muted-foreground",children:e})}),(0,a.jsx)(o.CardContent,{children:(0,a.jsx)("div",{className:`text-2xl font-semibold ${s?"text-muted-foreground":""}`,children:t})})]});return(0,a.jsx)(u.eu,{permission:"billing.read",children:(0,a.jsxs)("div",{className:"flex flex-col gap-6",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("h1",{className:"text-2xl font-semibold text-foreground flex items-center gap-2",children:[(0,a.jsx)(i.Z,{className:"h-6 w-6 text-blue-500"}),"Usage Billing"]}),(0,a.jsx)("p",{className:"text-muted-foreground",children:"Track metered usage (bandwidth, data transfer, equipment) and push into invoices."})]}),(0,a.jsx)("div",{className:"flex items-center gap-2",children:(0,a.jsxs)(o.Button,{variant:"outline",size:"sm",onClick:P,disabled:h,children:[(0,a.jsx)(n.Z,{className:`h-4 w-4 mr-2 ${h?"animate-spin":""}`}),"Refresh"]})})]}),y&&(0,a.jsxs)(o.Alert,{variant:"destructive",children:[(0,a.jsx)(d.Z,{className:"h-4 w-4"}),(0,a.jsx)(o.AlertTitle,{children:"Billing usage error"}),(0,a.jsx)(o.AlertDescription,{children:y})]}),(0,a.jsxs)("div",{className:"grid gap-4 grid-cols-1 md:grid-cols-3",children:[C("Total This Period",s?m.formatCurrency(s.total_amount):"—"),C("Pending Billing",s?m.formatCurrency(s.pending_amount):"—",!s),C("Records",s?s.total_records:h?"…":0,!s)]}),(0,a.jsxs)(o.Card,{children:[(0,a.jsxs)(o.CardHeader,{className:"flex flex-row items-center justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)(o.CardTitle,{children:"Log Usage"}),(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:"Capture metered usage that will roll into invoices or overage charges."})]}),(0,a.jsxs)(o.Button,{onClick:N,disabled:w,children:[(0,a.jsx)(l.Z,{className:"h-4 w-4 mr-2"}),"Record Usage"]})]}),(0,a.jsxs)(o.CardContent,{className:"grid gap-4 md:grid-cols-3",children:[(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"text-sm text-muted-foreground",children:"Usage Type"}),(0,a.jsxs)(o.Select,{value:j.usage_type,onValueChange:e=>U("usage_type",e),children:[(0,a.jsx)(o.SelectTrigger,{children:(0,a.jsx)(o.SelectValue,{placeholder:"Select type"})}),(0,a.jsx)(o.SelectContent,{children:Object.entries(x).map(([e,t])=>(0,a.jsx)(o.SelectItem,{value:e,children:t},e))})]})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"text-sm text-muted-foreground",children:"Quantity"}),(0,a.jsx)(o.Input,{type:"number",min:"0",step:"0.01",value:j.quantity,onChange:e=>U("quantity",Number(e.target.value))})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"text-sm text-muted-foreground",children:"Unit"}),(0,a.jsx)(o.Input,{value:j.unit,onChange:e=>U("unit",e.target.value)})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"text-sm text-muted-foreground",children:"Unit Price (major)"}),(0,a.jsx)(o.Input,{type:"number",min:"0",step:"0.01",value:j.unitPriceMajor,onChange:e=>U("unitPriceMajor",e.target.value)})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"text-sm text-muted-foreground",children:"Subscription ID (optional)"}),(0,a.jsx)(o.Input,{value:j.subscription_id,onChange:e=>U("subscription_id",e.target.value)})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"text-sm text-muted-foreground",children:"Customer ID (optional)"}),(0,a.jsx)(o.Input,{value:j.customer_id,onChange:e=>U("customer_id",e.target.value)})]}),(0,a.jsxs)("div",{className:"space-y-2 md:col-span-3",children:[(0,a.jsx)("label",{className:"text-sm text-muted-foreground",children:"Description (optional)"}),(0,a.jsx)(o.Input,{value:j.description,onChange:e=>U("description",e.target.value)})]}),(0,a.jsxs)("div",{className:"md:col-span-3 text-sm text-muted-foreground",children:["Estimated total:"," ",(0,a.jsx)("span",{className:"font-semibold text-foreground",children:S})]})]})]}),(0,a.jsxs)(o.Card,{children:[(0,a.jsxs)(o.CardHeader,{className:"flex flex-row items-center justify-between",children:[(0,a.jsx)(o.CardTitle,{children:"Recent Usage Records"}),(0,a.jsxs)(o.Badge,{variant:"secondary",children:[e.length," records"]})]}),(0,a.jsx)(o.CardContent,{className:"overflow-x-auto",children:(0,a.jsxs)(o.Table,{children:[(0,a.jsx)(o.TableHeader,{children:(0,a.jsxs)(o.TableRow,{children:[(0,a.jsx)(o.TableHead,{children:"Type"}),(0,a.jsx)(o.TableHead,{children:"Quantity"}),(0,a.jsx)(o.TableHead,{children:"Total"}),(0,a.jsx)(o.TableHead,{children:"Status"}),(0,a.jsx)(o.TableHead,{children:"Period End"}),(0,a.jsx)(o.TableHead,{children:"Source"})]})}),(0,a.jsxs)(o.TableBody,{children:[h&&(0,a.jsx)(o.TableRow,{children:(0,a.jsx)(o.TableCell,{colSpan:6,className:"text-center text-muted-foreground",children:"Loading usage records..."})}),!h&&0===e.length&&(0,a.jsx)(o.TableRow,{children:(0,a.jsx)(o.TableCell,{colSpan:6,className:"text-center text-muted-foreground",children:"No usage records yet."})}),!h&&e.map(e=>(0,a.jsxs)(o.TableRow,{children:[(0,a.jsx)(o.TableCell,{className:"font-medium",children:x[e.usage_type]||e.usage_type}),(0,a.jsxs)(o.TableCell,{children:[e.quantity," ",e.unit]}),(0,a.jsx)(o.TableCell,{children:m.formatCurrency(e.total_amount,e.currency)}),(0,a.jsx)(o.TableCell,{className:"capitalize",children:e.billed_status}),(0,a.jsx)(o.TableCell,{children:e.period_end?(0,c.WU)(new Date(e.period_end),"PPpp"):"—"}),(0,a.jsx)(o.TableCell,{className:"text-muted-foreground",children:e.source_system||"unknown"})]},e.id))]})]})})]})]})})}},19453:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>a});let a=(0,s(68570).createProxy)(String.raw`/Users/michaelayoade/Downloads/Projects/dotmac-ftth-ops/split-staging/dotmac-isp/frontend/apps/isp-ops-app/app/dashboard/billing-revenue/usage/page.tsx#default`)}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),a=t.X(0,[2793,1009,6226,657,6032,4218],()=>s(58295));module.exports=a})();